package com.astrodoorways.converter.metadata.handler;

import java.text.SimpleDateFormat;
import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.NamedNodeMap;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;


/**
 * Rosetta Handler. Example data found below.
 * Example Data
 QUALITY_MAP_IMAGE=BINARY20481281961LSB_UNSIGNED_INTEGER81RIGHTDOWN
 SR_MECHANISM_STATUS=22FFP-Vis_OrangeCLOSED
 PROCESSING_HISTORY_TEXT=Level 2 PDS file created - OsiCalliope 2015-07-18
 ORIGIN_ROTATION_QUATERNION=NULL
 PIXEL_AVERAGING_HEIGHT= 1
 ^HISTORY=41
 START_TIME=2014-03-20T20:49:59.690
 AZIMUTH_FOV=2.197
 VOLUME_NAME=N/A
 BANDS=1
 EXPOSURE_TYPE=MANUAL
 SPACECRAFT_ALTITUDE=5091371.44110
 STOP_TIME=2014-03-20T20:50:00.690
 PROCESSING_LEVEL_ID=2
 SPACECRAFT_CLOCK_STOP_COUNT=1/353969336.35616
 MISSION_ID=ROSETTA
 TELESCOPE_RESOLUTION=1.872000e-005
 SPACECRAFT_CLOCK_START_COUNT=1/353969335.35616
 SR_SWITCH_STATUS=OFFOFFOFFOFFOFFOFFOFFOFFOFFOFFONOFFONHEATER1HEATER1OFFOFFOFFIFPLATEHEATERIFPLATEHEATEROFFONOFFOFFONMAINMAIN
 SR_HEATER_STATUS=0.0001.5180.0004.1060.0002.4150.0002.6170.000
 SR_COMPRESSION= 0 0 0 0 0 0 0 0 0 512 1024 1536 128 128 128 128 512 512 512 512SPIHT_LIFT SPIHT_LIFT SPIHT_LIFT SPIHT_LIFT  1.7 <:1>   1.7 <:1>   1.7 <:1>   1.7 <:1> TRUE TRUE TRUE TRUE 6 6 6 6 23 10 11 11 390 427 434 403 2 2 2 2 3 3 3 3 1 1 1 1 1 1 1 1 NONE NONE NONE NONE FALSE FALSE FALSE FALSE  1.1  1.1  1.1  1.1
 IMAGE_ID=0
 SPACECRAFT_SOLAR_DISTANCE=638531690.895
 SR_SHUTTER_CONFIG=429496729516#39#FALSETRUETRUESLOW
 VOLUME_SET_ID=N/A
 SR_RADIATION_STATUS=463.6000
 LABEL_REVISION_NOTE=V3.2 Oct 10 2005 MPS Osiris Team
 FILTER_NUMBER=22
 SAMPLE_DISPLAY_DIRECTION=RIGHT
 RECORD_TYPE=FIXED_LENGTH
 REFERENCE_COORD_SYSTEM_NAME=S/C-COORDS
 ^SIGMA_MAP_IMAGE=2096
 PRODUCT_VERSION_ID=1
 SOFTWARE_RELEASE_DATE=2015-07-14
 DECLINATION=-13.23217
 LINES=2048
 GEOMETRIC_CAMERA_MODEL=CAHV C A H V CENTER AXIS HORIZONTAL VERTICALNULLNULLNULLNULL
 VOLUME_SERIES_NAME=ROSETTA SCIENCE ARCHIVE
 PRODUCER_FULL_NAME=Pablo Gutierrez-Marques
 SAMPLE_BITS=32
 SR_TEMPERATURE_STATUS=148.4143.4285.0285.7285.2285.5288.0286.8281.4281.4282.7203.2170.9253.7254.5252.7248.2225.3255.3248.2255.3224.3290.8284.0288.5286.8148.9265.4277.1276.1255.3254.9299.7273.5
 VOLUME_SET_NAME=N/A
 NOTE=The values of the keywords SC_SUN_POSITION_VECTOR SC_TARGET_POSITION_VECT OR and SC_TARGET_VELOCITY_VECTOR are related to the Earth Mean Equator  J2000 reference frame. The values of SUB_SPACECRAFT_LATITUDE and  SUB_SPACECRAFT_LONGITUDE  are northern latitude and eastern longitude in the  standard  planetocentric IAU_<TARGET_NAME> frame. All values are computed for the time t = START_TIME. Distances are given in <km> velocities in <km/s>, Angles in <deg>.
 ELEVATION_FOV=2.341
 RIGHT_ASCENSION=247.83928
 INSTRUMENT_TYPE=FRAME CCD REFLECTING TELESCOPE
 MODEL_COMPONENT_NAME= VERTICAL
 INSTRUMENT_NAME=OSIRIS - NARROW ANGLE CAMERA
 SOFTWARE_DESC=OSIRIS calibration pipeline
 DETECTOR_PIXEL_WIDTH=13.5
 ^QUALITY_MAP_IMAGE=4144
 SR_STATUS_FLAGS=FALSEFALSEFALSESUCCESS
 TARGET_NAME=67P/CHURYUMOV-GERASIMENKO 1 1969 R1
 PHASE_ANGLE=32.6781
 FIRST_LINE=1
 VOLUME_FORMAT=ANSI
 SR_POWER_STATUS=-4.73.3-2.5-1.7-5.85.2-9.9-10.024.98.3-12.25.35.2-5.21648.4-94.41754.0129.7-333.650.417.811.388.7118.2118.864.5
 MODEL_TYPE=CAHV
 SC_TARGET_VELOCITY_VECTOR= 0.177 <km/s>
 IMAGE_OBSERVATION_TYPE=REGULAR
 LABEL_RECORDS=40
 SAMPLE_TYPE=PC_REAL
 TARGET_CENTER_DISTANCE=5091360.18094
 DETECTOR_PIXEL_HEIGHT=13.5
 DETECTOR_DESC=2048x2048 PIXELS BACKLIT FRAME CCD DETECTOR
 SPICE_FILE_NAME=ck\CATT_DV_123_01_______00192.BC
 INSTRUMENT_HOST_NAME=ROSETTA-ORBITER
 FILE_NAME=N20140320T204855543ID20F22.IMG
 SUB_SPACECRAFT_LONGITUDE=-7.35598
 PRODUCER_INSTITUTION_NAME=Max Planck Institute for Solar System Research
 IMAGE_POI=N/AN/AN/ACHEOPS 1.0N/AN/AN/AN/A
 TELESCOPE_FOCAL_LENGTH=0.7168
 TELESCOPE_F_NUMBER=8.000000
 TARGET_TYPE=COMET
 SOFTWARE_VERSION_ID=1.0.0.18
 LINE_SAMPLES=128
 DATA_QUALITY_DESC=Zero is good non zero is bad
 PROCESSING_LEVEL_DESC=Radiometrically calibrated data
 DETECTOR_TYPE=SI CCD
 FILE_RECORDS=4655
 SR_ACQUIRE_OPTIONS=HIGHSPEEDQUEUE31.000022FFP-Vis_OrangeFALSE1x1BHIGHTANDEMFALSEFALSETRUETRUETRUETRUEFALSEFALSETRUETRUEFALSE00ELECTRICAL9601088020480.250017FALSEFALSEFALSE
 VOLUMES=UNK
 PRODUCER_ID=MPS
 IMAGE=BINARY20481281961PC_REAL321W/M**2/SR/NMRIGHTDOWN
 COORDINATE_SYSTEM_NAME=NAC_CAMERA_FRAME
 DETECTOR_ID=EEV-243
 PRODUCT_TYPE=CALIBRATED_IMAGE
 INTERCHANGE_FORMAT=BINARY
 LINE_DISPLAY_DIRECTION=DOWN
 SOFTWARE_NAME=OsiCalliope.exe
 SR_DATA_CONTENT=FALSEFALSEFALSETRUETRUETRUE
 PRODUCT_ID=N20140320T204855543ID20F22
 QUATERNION_DESC=nx sin(a/2
 BAD_PIXEL_REPLACEMENT_FLAG=FALSE
 PIXEL_AVERAGING_WIDTH= 1
 DATA_SET_NAME=ROSETTA-ORBITER COMET PRELANDING OSINAC 2 EDR data
 MISSION_NAME=INTERNATIONAL ROSETTA MISSION
 DETECTOR_TEMPERATURE=148.85
 INSTRUMENT_ID=OSINAC
 DATA_SET_ID=RO-C-OSINAC-2-PRL-67PCHURYUMOV-M01-V1.0
 EXPOSURE_DURATION=1.0000
 UNIT=W/M**2/SR/NM
 ORIGIN_OFFSET_VECTOR=NULL
 SR_PROCESSING_FLAGS=TRUEFALSEFALSEFALSEFALSEFALSE
 MEDIUM_TYPE=ELECTRONIC
 SR_HARDWARE_CONFIG=FSFSFSFMFMFMFM
 VOLUME_ID=N/A
 CAMERA_COORDINATE_SYSTEM=NAC_CAMERA_FRAMENULLNULLnx sin(a/2S/C-COORDS
 FILTER_NAME=FFP-Vis_Orange
 MISSION_PHASE_NAME=PRELANDING
 SOLAR_ELONGATION=147.29726
 PUBLICATION_DATE=2015-07-18
 MODEL_COMPONENT_3=NULL
 MODEL_COMPONENT_2=NULL
 MODEL_COMPONENT_1=NULL
 MODEL_COMPONENT_4=NULL
 NORTH_AZIMUTH=303.64237
 SR_SHUTTER_STATUS=16#6000600#SHUTTER_ERROR_NONE0.0000000.0000000.0000000.0000000.0000000.0000000.0000000.000000
 ^IMAGE=48
 FIRST_LINE_SAMPLE=961
 VOLUME_VERSION_ID=N/A
 SUB_SPACECRAFT_LATITUDE=-30.55632
 PRODUCT_CREATION_TIME=2015-07-18T18:26:51
 DARK_CURRENT_CORRECTION_FLAG=FALSE
 SIGMA_MAP_IMAGE=BINARY20481281961PC_REAL321RIGHTDOWN
 SC_SUN_POSITION_VECTOR= 304712663.722
 SC_COORDINATE_SYSTEM=S/C-COORDSJ2000 to Rosetta Coordinate System quaternion nx sin(a/2 ny sin(a/2) EME J2000
 INSTRUMENT_HOST_ID=RO
 DATA_QUALITY_ID=0
 MODEL_COMPONENT_ID= V
 RECORD_BYTES=512
 SC_TARGET_POSITION_VECTOR= -1160009.378
 */
public class RosettaHandler extends AbstractVicarHandler {

	private final Logger logger = LoggerFactory.getLogger(RosettaHandler.class);

	public final SimpleDateFormat ROSETTA_FORMATTER = new SimpleDateFormat("yyyy-MM-DD'T'HH:mm:ss.SSS"); //2014-10-24T11:34:35.924

	@Override
	public Map<String, String> buildValueMapFromMetadata(Node node) {
		getValueMap().put(EXPOSURE, getValueMap().get("EXPOSURE_DURATION"));
		String time = getValueMap().get("START_TIME");

		getValueMap().put(TIME, time);
		getValueMap().put(CAMERA, getValueMap().get("INSTRUMENT_NAME").replace(" ", ""));//extractValue("INSTRUMENT_ID", nodeString));
		getValueMap().put(TARGET, getValueMap().get("TARGET_NAME").replace(" ", "-"));
		getValueMap().put(MISSION, getValueMap().get("MISSION_NAME").replace(" ", "-"));
		getValueMap().put(FILTER, getValueMap().get("FILTER_NAME").replace(" ", "-"));
		return getValueMap();
	}

	@Override
	public SimpleDateFormat getFormatter() {
		return ROSETTA_FORMATTER;
	}

	@Override
	public boolean canProcessMetadata(Node node) {
		convertMetadataNodeToHashMap(node, "n");
		return getValueMap().get("MISSION_NAME").contains("ROSETTA");
	}

	public void convertMetadataNodeToHashMap(Node node, String prefix) {
		String val = node.getTextContent();
		logger.trace("{}: {}", new Object[] { prefix, val });

		if (!prefix.endsWith("a")) {
			NamedNodeMap map = node.getAttributes();
			if (map != null && map.getLength() > 0) {
				String key = map.item(0).getTextContent();
				getValueMap().put(key, val);
				convertMetadataNodeToHashMap(map.item(0), prefix + "a");
			}
			NodeList nodeList = node.getChildNodes();
			if (nodeList != null) {
				for (int i = 0; i < nodeList.getLength(); i++) {
					convertMetadataNodeToHashMap(nodeList.item(i), prefix + "c");
				}
			}
		}
	}
}
